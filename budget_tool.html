<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta charset="UTF-8">
  <title>Daily Budget Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      max-width: 500px;
      margin: auto;
    }
    h1 {
      text-align: center;
    }
    .balance {
      font-size: 1.8em;
      text-align: center;
      margin: 10px 0;
    }
    input, button {
      padding: 6px;
      margin: 4px 0;
      width: 100%;
    }
    .row {
      display: flex;
      gap: 5px;
    }
    .row input {
      flex: 1;
    }
    .log {
      max-height: 250px;
      overflow-y: auto;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
    }
    .entry {
      display: flex;
      gap: 5px;
      margin-bottom: 5px;
    }
    .entry input {
      flex: 1;
    }
    .entry button {
      width: 60px;
    }
  </style>
</head>
<body>

<h1>Daily Budget</h1>

<label>Daily Allowance ($)</label>
<input type="number" id="dailyBudget" step="0.01">

<div class="balance">
  Balance: $<span id="balance">0.00</span>
</div>

<h3>Add Transaction</h3>
<div class="row">
  <input id="nameInput" placeholder="Name">
  <input id="priceInput" type="number" step="0.01" placeholder="Price">
</div>
<button onclick="addTransaction()">Add</button>

<h3>Transactions</h3>
<div class="log" id="log"></div>

<script>
  const STORAGE_KEY = "budgetAppData";

  let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
    balance: 0,
    dailyBudget: 50,
    lastAllowanceDate: null,
    transactions: []
  };

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function updateUI() {
    document.getElementById("balance").textContent = data.balance.toFixed(2);
    document.getElementById("dailyBudget").value = data.dailyBudget;
    renderLog();
  }
function formatDay(day) {
  return new Date(day).toLocaleDateString();
}

function formatTime(ts) {
  return new Date(ts).toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit"
  });
}
function daysBetween(date1, date2) {
  const d1 = new Date(date1);
  const d2 = new Date(date2);
  return Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));
}

function applyDailyAllowance() {
  const now = new Date();

  // Local noon check
  if (now.getHours() < 12) return;

  const today = getLocalDay(now);

  if (!data.lastAllowanceDate) {
    creditDay(today);
    data.lastAllowanceDate = today;
    save();
    return;
  }

  let cursor = new Date(data.lastAllowanceDate);
  cursor.setDate(cursor.getDate() + 1);

  while (getLocalDay(cursor) <= today) {
    creditDay(getLocalDay(cursor));
    cursor.setDate(cursor.getDate() + 1);
  }

  data.lastAllowanceDate = today;
  save();
}

function creditDay(day) {
  const amount = Number(data.dailyBudget);
  data.balance += amount;

  const noon = new Date(`${day}T12:00`);

  data.transactions.push({
    id: Date.now() + Math.random(),
    name: "Daily Allowance",
    price: -amount,
    day,
    timestamp: getLocalTimestamp(noon)
  });
}



function addTransaction() {
  const name = document.getElementById("nameInput").value.trim();
  const price = parseFloat(document.getElementById("priceInput").value);

  if (!name || isNaN(price)) return;

  const now = new Date();

  data.balance -= price;
  data.transactions.push({
    id: Date.now(),
    name,
    price,
    day: getLocalDay(now),
    timestamp: getLocalTimestamp(now)
  });

  document.getElementById("nameInput").value = "";
  document.getElementById("priceInput").value = "";

  save();
  updateUI();
}

function getLocalDay(date = new Date()) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, "0");
  const d = String(date.getDate()).padStart(2, "0");
  return `${y}-${m}-${d}`;
}

function getLocalTimestamp(date = new Date()) {
  const offset = date.getTimezoneOffset() * 60000;
  return new Date(date - offset).toISOString().slice(0, -1);
}


function renderLog() {
  const log = document.getElementById("log");
  log.innerHTML = "";

  [...data.transactions].reverse().forEach((t, reversedIndex) => {
    const index = data.transactions.length - 1 - reversedIndex;

    const div = document.createElement("div");
    div.className = "entry";
    div.style.flexDirection = "column";

    // Date header
    const meta = document.createElement("div");
    meta.style.fontSize = "0.8em";
    meta.style.opacity = "0.7";
    meta.textContent = `${formatDay(t.day)} â€¢ ${formatTime(t.timestamp)}`;

    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.gap = "5px";

    const nameInput = document.createElement("input");
    nameInput.value = t.name;

    const priceInput = document.createElement("input");
    priceInput.type = "number";
    priceInput.step = "0.01";
    priceInput.value = t.price;

    const saveBtn = document.createElement("button");
    saveBtn.textContent = "Save";
    saveBtn.onclick = () => {
      const oldPrice = t.price;
      t.name = nameInput.value;
      t.price = parseFloat(priceInput.value);
      data.balance += oldPrice - t.price;
      save();
      updateUI();
    };

    const delBtn = document.createElement("button");
    delBtn.textContent = "Del";
    delBtn.onclick = () => {
      data.balance += t.price;
      data.transactions.splice(index, 1);
      save();
      updateUI();
    };

    row.append(nameInput, priceInput, saveBtn, delBtn);
    div.append(meta, row);
    log.appendChild(div);
  });
}

  document.getElementById("dailyBudget").addEventListener("change", e => {
    data.dailyBudget = parseFloat(e.target.value);
    save();
  });

  // Initial run
  applyDailyAllowance();
  updateUI();

  // Re-check allowance every minute
  setInterval(() => {
    applyDailyAllowance();
    updateUI();
  }, 60000);
</script>

</body>
</html>
